(function($){
	$.fn.commentImg = function(options){
		var defaults = {
			activeClass: 'current',
        	nextButton: '.next',
        	prevButton: '.prev',
			imgNavBox:'.photos-thumb',
			imgViewBox:'.photo-viewer',
			videothumb: '.video-useless',
            videothumbBox: '.tm-m-video-viewer'
		};
		var opts = $.extend({},defaults, options);

		this.each(function(){
			var _this =$(this),
				imgNav =_this.find(opts.imgNavBox),
				videoViewBox = _this.find(opts.videothumbBox),
				videoView = _this.find(opts.videothumb),
				imgViewBox =_this.find(opts.imgViewBox),
				prevBtn = _this.find(opts.prevButton),
				nextBtn = _this.find(opts.nextButton),
				src = '',
				img = new Image();
				
			function setViewImg(viewSrc){
				img.src = viewSrc;
	            img.onload = function () {	                
					var imageWidth = "400px";
	                var imageHeight = "400px";	               
	                imgViewBox.show(0,function(){
	                	$(this).css({ "width": imageWidth, "height": imageHeight }).find("img").attr('src', src);
	                });					
				}	
				if(imgNav.length<=1){
					nextBtn.hide();
					prevBtn.hide();
				}
			}

			function setViewVideo(viewSrc) {
                videoViewBox.show(0, function() {
                    $(this).css({ "width": "400px", "height": "400px" }).append("<video controls autoplay src='" + viewSrc + "?a=" + new Date().getTime() + "'></video>");
                })
            }
			
			imgNav.on("click",function(){
				$(this).toggleClass(opts.activeClass).siblings().removeClass(opts.activeClass);			
				if($(this).hasClass(opts.activeClass)){
					cancelVideoPreview();
					src = $(this).attr('data-src');	
		            setViewImg(src);
				}else{
					imgViewBox.css({ "width": 0, "height": 0 }).hide();
				}
			});

			// 预览视频
            videoView.on("click", function() {
                $(this).toggleClass(opts.activeClass).siblings().removeClass(opts.activeClass);
                if($(this).hasClass(opts.activeClass)){
                    cancelImgPreview();
					src = $(this).attr('data-src');	
		            setViewVideo(src);
				}else{
                    videoViewBox.find("video").remove();
					videoViewBox.css({ "width": 0, "height": 0 }).hide();
				}
            })
			
			videoViewBox.find("a").on("click", cancelVideoPreview);
			imgViewBox.on("click",cancelImgPreview);

			function cancelVideoPreview() {
				videoView.removeClass(opts.activeClass);
                videoViewBox.find("video").remove();
                videoViewBox.css({ "width": 0, "height": 0 }).hide();
			}

			function cancelImgPreview() {
				imgNav.removeClass(opts.activeClass);			
				imgViewBox.css({ "width": 0, "height": 0 }).hide();
			}
			
			prevBtn.hover(function () {				
	            var index = imgNav.index(_this.find("." + opts.activeClass));	            
	            if (index < 1) {
	                $(this).css({"cursor":"default"}).children().hide();	      
	            } else {
	                $(this).css({"cursor":"pointer"}).children().show();
	            }
	        }, function () {
	            $(this).css({"cursor":"default"}).children().hide();
	        });	
	        
	        nextBtn.hover(function () {
	            var index = imgNav.index(_this.find("." + opts.activeClass));	            
	            if (index >= imgNav.length - 1) {
	                $(this).css({"cursor":"default"}).children().hide();		                
	            } else {
	                $(this).css({"cursor":"pointer"}).children().show();
	            }
	        }, function () {
	            $(this).css({"cursor":"default"}).children().hide();
	        });
	        
	        prevBtn.on("click",function (e) {
	        	e.stopPropagation();
				var index = imgNav.index(_this.find("." + opts.activeClass));     	            
	            if (index > 0) {
	            	index--;
	            	imgNav.eq(index).toggleClass(opts.activeClass).siblings().removeClass(opts.activeClass);
                	src = imgNav.eq(index).attr('data-src');	
					setViewImg(src);
	            }            
	            if (index <= 0) {	          
	                $(this).css({"cursor":"default"}).children().hide();
	            }
	        });
	        
	        nextBtn.on("click",function (e) {
	        	e.stopPropagation();
				var index = imgNav.index(_this.find("." + opts.activeClass));
	            if (index < imgNav.length - 1) {
	            	index++;
	            	imgNav.eq(index).toggleClass(opts.activeClass).siblings().removeClass(opts.activeClass);
	            	src = imgNav.eq(index).attr('data-src');	
		            setViewImg(src);	
	    		}
	            if (index >= imgNav.length - 1) {
	                $(this).css({"cursor":"default"}).children().hide();
	            }
	        })
				
		})
	
	}

})(jQuery);


